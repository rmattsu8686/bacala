<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Baccarat Ultimate Edition</title>
    <style>
        body { background: #064721; color: white; text-align: center; font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; touch-action: manipulation; }
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }

        /* HUD: ステータス */
        .hud { height: 40px; display: flex; justify-content: space-around; align-items: center; background: rgba(0,0,0,0.9); font-size: 12px; font-weight: bold; border-bottom: 2px solid #444; flex-shrink: 0; }
        .stat-p { color: #3498db; } .stat-b { color: #e74c3c; } .stat-t { color: #2ecc71; }
        #balance { color: #ffd700; font-size: 16px; text-shadow: 0 0 8px rgba(255,215,0,0.6); }

        #msg { height: 35px; font-size: 14px; color: #ffd700; font-weight: bold; display: flex; align-items: center; justify-content: center; text-shadow: 0 0 10px rgba(255,215,0,0.5); flex-shrink: 0; }

        /* テーブルエリア */
        .table { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; gap: 2px; }
        .hand-container { height: 90px; display: flex; justify-content: center; gap: 8px; perspective: 1000px; align-items: center; }
        .label { font-size: 10px; opacity: 0.7; }

        /* カードデザイン */
        .card { width: 58px; height: 86px; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card.back { cursor: pointer; animation: pulse 1s infinite; z-index: 100; }
        .card.open { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 5px; box-sizing: border-box; border: 1px solid #ccc; }
        .card-back { background: #b30000; background-image: radial-gradient(circle, #ff3333 1px, transparent 1px); background-size: 8px 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .card-front { background: white; color: black; transform: rotateY(180deg); display: flex; flex-direction: column; padding: 0; position: relative; }
        .corner { position: absolute; font-size: 13px; font-weight: bold; line-height: 1; padding: 3px 5px; }
        .corner.bottom { transform: rotate(180deg); bottom: 0; right: 0; }
        .pips-area { margin: 14px 6px; flex-grow: 1; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(5, 1fr); align-items: center; justify-items: center; font-size: 9px; }
        .pip-big { font-size: 38px; height: 100%; display: flex; align-items: center; justify-content: center; }
        .red { color: #d40000; } .black { color: #000; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 15px #ffd700; } 100% { transform: scale(1); } }

        /* チップ・ベットエリア */
        .bet-info { font-size: 16px; color: #ffd700; font-weight: bold; margin-bottom: 5px; }
        .chip-container { height: 75px; display: flex; justify-content: center; gap: 10px; align-items: center; background: rgba(0,0,0,0.4); flex-shrink: 0; padding: 0 10px; }
        
        .chip { 
            width: 44px; height: 44px; border-radius: 50%; border: 3px dashed rgba(255,255,255,0.8); 
            display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; 
            cursor: pointer; transition: 0.1s; box-shadow: 0 4px 0 #222, 0 6px 10px rgba(0,0,0,0.5);
            position: relative;
        }
        .chip:active { transform: translateY(2px); box-shadow: 0 2px 0 #222; }
        
        /* チップごとのリッチカラー */
        .chip-10 { background: radial-gradient(circle, #eee, #999); color: black; }
        .chip-50 { background: radial-gradient(circle, #f33, #900); color: white; }
        .chip-100 { background: radial-gradient(circle, #33f, #006); color: white; }
        .chip-500 { background: radial-gradient(circle, #444, #000); color: #ffd700; border-color: #ffd700; }
        
        .btn-special { background: #555; border: 1px solid #777; border-radius: 4px; padding: 5px 10px; font-size: 10px; color: white; cursor: pointer; margin: 0 5px; }

        /* 操作ボタン */
        .controls { height: 60px; display: flex; justify-content: center; gap: 15px; align-items: center; flex-shrink: 0; }
        .bet-btn { padding: 12px 28px; font-size: 16px; border: none; border-radius: 30px; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 4px #222; }
        #btn-p { background: linear-gradient(#3498db, #2980b9); }
        #btn-b { background: linear-gradient(#e74c3c, #c0392b); }
        .bet-btn:disabled { opacity: 0.3; filter: grayscale(1); }

        /* スコアボード */
        .scoreboard-container { background: #111; margin: 2px auto; width: 95%; height: 74px; overflow-x: auto; border: 2px solid #444; border-radius: 4px; display: flex; flex-shrink: 0; }
        .big-road { display: grid; grid-template-rows: repeat(6, 12px); grid-auto-flow: column; grid-auto-columns: 12px; gap: 0px; }
        .road-cell { width: 12px; height: 12px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #222; border-bottom: 1px solid #222; position: relative; }
        .circle { width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid; }
        .circle.p { border-color: #3498db; background: radial-gradient(circle at 30% 30%, #5dade2, #2e86c1); }
        .circle.b { border-color: #e74c3c; background: radial-gradient(circle at 30% 30%, #ec7063, #cb4335); }
        .tie-line { position: absolute; width: 100%; height: 2px; background: #2ecc71; transform: rotate(-45deg); z-index: 1; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="hud">
    <span>CASH: <span id="balance">$1000</span></span>
    <span class="stat-p">P:<span id="stat-p">0</span></span>
    <span class="stat-b">B:<span id="stat-b">0</span></span>
    <span class="stat-t">T:<span id="stat-t">0</span></span>
</div>

<div id="msg">PLACE YOUR BET</div>

<div class="table">
    <div><span class="label">BANKER</span> <span id="b-val"></span></div>
    <div id="b-hand" class="hand-container"></div>
    <div><span class="label">PLAYER</span> <span id="p-val"></span></div>
    <div id="p-hand" class="hand-container"></div>
</div>

<div class="bet-info">BET: $<span id="current-bet">0</span></div>

<div class="chip-container">
    <button class="btn-special" onclick="clearBet()">CLEAR</button>
    <div class="chip chip-10" onclick="addBet(10)">10</div>
    <div class="chip chip-50" onclick="addBet(50)">50</div>
    <div class="chip chip-100" onclick="addBet(100)">100</div>
    <div class="chip chip-500" onclick="addBet(500)">500</div>
    <button class="btn-special" onclick="allIn()">ALL IN</button>
</div>

<div class="controls">
    <button id="btn-p" class="bet-btn" onclick="game('PLAYER')">PLAYER</button>
    <button id="btn-b" class="bet-btn" onclick="game('BANKER')">BANKER</button>
</div>

<div class="scoreboard-container">
    <div id="big-road" class="big-road"></div>
</div>

<script>
    let audioCtx;
    function playSound(freq, type, duration, vol=0.1) {
        try {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        } catch(e) {}
    }

    const sounds = {
        deal: () => playSound(600, 'sine', 0.1),
        flip: () => playSound(400, 'square', 0.1),
        chip: () => playSound(800, 'sine', 0.05, 0.05),
        win: () => { playSound(523, 'sine', 0.2); setTimeout(()=>playSound(783, 'sine', 0.4), 150); },
        lose: () => playSound(150, 'sawtooth', 0.4)
    };

    let cash = 1000;
    let currentBet = 0;
    let dealing = false;
    let history = [];
    let stats = { P: 0, B: 0, T: 0 };
    const suits = [{s:'♠',c:'black'}, {s:'♥',c:'red'}, {s:'♦',c:'red'}, {s:'♣',c:'black'}];
    const pipMap = { 1:[7], 2:[1,13], 3:[1,7,13], 4:[0,2,12,14], 5:[0,2,7,12,14], 6:[0,2,6,8,12,14], 7:[0,2,4,6,8,12,14], 8:[0,2,4,6,8,10,12,14], 9:[0,2,3,5,6,8,9,11,7], 10:[0,3,9,12,4,10,2,5,11,14] };

    function addBet(amt) {
        if (dealing) return;
        if (cash < currentBet + amt) {
            currentBet = cash;
        } else {
            currentBet += amt;
        }
        sounds.chip();
        document.getElementById('current-bet').innerText = currentBet;
    }

    function clearBet() {
        if (dealing) return;
        currentBet = 0;
        sounds.chip();
        document.getElementById('current-bet').innerText = currentBet;
    }

    function allIn() {
        if (dealing) return;
        currentBet = cash;
        sounds.chip();
        document.getElementById('current-bet').innerText = currentBet;
    }

    async function game(betSide) {
        if (dealing || currentBet <= 0 || cash < currentBet) {
            if (currentBet <= 0) document.getElementById('msg').innerText = "PLEASE PLACE A BET!";
            return;
        }
        dealing = true;
        const gameBet = currentBet;
        cash -= gameBet;
        document.getElementById('balance').innerText = '$' + cash;
        document.getElementById('p-hand').innerHTML = ''; document.getElementById('b-hand').innerHTML = '';
        document.getElementById('p-val').innerText = ''; document.getElementById('b-val').innerText = '';
        document.getElementById('btn-p').disabled = true; document.getElementById('btn-b').disabled = true;

        let pHand = [randCard(), randCard()], bHand = [randCard(), randCard()];
        const steps = [{l:'P 1st', id:'p-hand', c:pHand[0]},{l:'B 1st', id:'b-hand', c:bHand[0]},{l:'P 2nd', id:'p-hand', c:pHand[1]},{l:'B 2nd', id:'b-hand', c:bHand[1]}];

        for(let s of steps) {
            document.getElementById('msg').innerText = "SQUEEZE " + s.l + "...";
            await addCard(s.id, s.c);
        }

        let ps = calc(pHand), bs = calc(bHand);
        updateScores(ps, bs);

        // ルール判定
        let p3v = -1;
        if (ps < 8 && bs < 8) {
            if (ps <= 5) {
                let p3 = randCard(); pHand.push(p3); p3v = getVal(p3.n);
                document.getElementById('msg').innerText = 'PLAYER DRAWS 3rd...';
                await addCard('p-hand', p3);
                ps = calc(pHand); updateScores(ps, bs);
            }
            let bDraw = false;
            if (p3v === -1) { if (bs <= 5) bDraw = true; }
            else {
                if (bs <= 2) bDraw = true;
                else if (bs === 3 && p3v !== 8) bDraw = true;
                else if (bs === 4 && [2,3,4,5,6,7].includes(p3v)) bDraw = true;
                else if (bs === 5 && [4,5,6,7].includes(p3v)) bDraw = true;
                else if (bs === 6 && [6,7].includes(p3v)) bDraw = true;
            }
            if (bDraw) {
                let bc = randCard(); bHand.push(bc);
                document.getElementById('msg').innerText = 'BANKER DRAWS 3rd...';
                await addCard('b-hand', bc);
                bs = calc(bHand); updateScores(ps, bs);
            }
        }

        let res = ps > bs ? "PLAYER" : (bs > ps ? "BANKER" : "TIE");
        updateHistory(res);
        
        if (betSide === res) {
            let winAmt = res === "BANKER" ? gameBet * 1.95 : gameBet * 2;
            document.getElementById('msg').innerText = "WIN! +$" + winAmt.toFixed(0);
            cash += winAmt;
            sounds.win(); startConfetti();
        } else if (res === "TIE") {
            document.getElementById('msg').innerText = "TIE (PUSH)";
            cash += gameBet;
            sounds.flip();
        } else {
            document.getElementById('msg').innerText = res + " WIN";
            sounds.lose();
        }

        document.getElementById('balance').innerText = '$' + Math.floor(cash);
        document.getElementById('btn-p').disabled = false; document.getElementById('btn-b').disabled = false;
        currentBet = 0;
        document.getElementById('current-bet').innerText = 0;
        dealing = false;
    }

    function addCard(id, data) {
        return new Promise(resolve => {
            sounds.deal();
            let container = document.getElementById(id);
            let card = document.createElement('div');
            card.className = 'card back';
            let rank = data.n === 1 ? 'A' : data.n === 11 ? 'J' : data.n === 12 ? 'Q' : data.n === 13 ? 'K' : data.n;
            let pips = (data.n <= 10) ? `<div class="pips-area">${Array.from({length:15}, (_,i)=>`<div>${pipMap[data.n].includes(i)?data.s.s:''}</div>`).join('')}</div>` : `<div class="pip-big">${data.s.s}</div>`;
            card.innerHTML = `<div class="card-front ${data.s.c}"><div class="corner top">${rank}</div>${pips}<div class="corner bottom">${rank}</div></div><div class="card-back"></div>`;
            container.appendChild(card);
            card.onclick = () => { sounds.flip(); card.classList.remove('back'); card.classList.add('open'); setTimeout(resolve, 600); };
        });
    }

    function updateScores(p, b) {
        document.getElementById('p-val').innerText = "(" + p + ")";
        document.getElementById('b-val').innerText = "(" + b + ")";
    }

    function updateHistory(res) {
        if(res === "PLAYER") stats.P++; else if(res === "BANKER") stats.B++; else stats.T++;
        document.getElementById('stat-p').innerText = stats.P;
        document.getElementById('stat-b').innerText = stats.B;
        document.getElementById('stat-t').innerText = stats.T;
        history.push(res);
        renderRoad();
    }

    function renderRoad() {
        const road = document.getElementById('big-road'); road.innerHTML = '';
        let columns = [[]], currentCol = 0;
        history.forEach((res) => {
            if (res === "TIE") {
                let target = columns[currentCol].length > 0 ? columns[currentCol][columns[currentCol].length-1] : (currentCol > 0 ? columns[currentCol-1][columns[currentCol-1].length-1] : null);
                if(target) target.tie = true;
            } else {
                let type = res[0];
                if (columns[currentCol].length > 0 && columns[currentCol][0].type !== type) { currentCol++; columns[currentCol] = []; }
                if (columns[currentCol].length >= 6) { currentCol++; columns[currentCol] = [{type:type, tie:false}]; }
                else { columns[currentCol].push({type:type, tie:false}); }
            }
        });
        columns.forEach(col => {
            for (let i = 0; i < 6; i++) {
                const cell = document.createElement('div'); cell.className = 'road-cell';
                if (col[i]) {
                    if (col[i].type) { const circ = document.createElement('div'); circ.className = 'circle ' + col[i].type.toLowerCase(); cell.appendChild(circ); }
                    if (col[i].tie) { const line = document.createElement('div'); line.className = 'tie-line'; cell.appendChild(line); }
                }
                road.appendChild(cell);
            }
        });
        document.querySelector('.scoreboard-container').scrollLeft = 9999;
    }

    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function startConfetti() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        particles = Array.from({length:80}, () => ({ x: Math.random()*canvas.width, y: -20, r: Math.random()*6+4, d: Math.random()*10, color: `hsl(${Math.random()*360}, 100%, 50%)`, tilt: Math.random()*10 }));
        drawConfetti();
    }
    function drawConfetti() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles.forEach((p, i) => {
            p.y += 3; ctx.beginPath(); ctx.strokeStyle = p.color; ctx.lineWidth = p.r; ctx.moveTo(p.x+p.tilt, p.y); ctx.lineTo(p.x, p.y+p.tilt); ctx.stroke();
            if(p.y > canvas.height) particles.splice(i, 1);
        });
        if(particles.length > 0) requestAnimationFrame(drawConfetti);
    }

    function randCard() { return { n: Math.floor(Math.random()*13)+1, s: suits[Math.floor(Math.random()*4)] }; }
    function getVal(n) { return n >= 10 ? 0 : n; }
    function calc(hand) { return hand.reduce((a, b) => a + getVal(b.n), 0) % 10; }
</script>
</body>
</html>